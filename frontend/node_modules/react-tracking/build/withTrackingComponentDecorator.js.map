{"version":3,"sources":["../src/withTrackingComponentDecorator.js"],"names":["ReactTrackingContext","React","createContext","withTrackingComponentDecorator","trackingData","dispatch","dispatchTrackingEvent","dispatchOnMount","process","forwardRef","DecoratedComponent","decoratedComponentName","displayName","name","WithTracking","rtFwdRef","props","tracking","latestProps","current","trkProcess","getProcessFn","getOwnTrackingData","ownTrackingData","getTrackingDataFn","contextGetTrackingData","getTrackingData","getTrackingDispatcher","contextDispatch","data","trackEvent","contextProcess","console","error","processed","trackingProp","contextValue","propsToBePassed","ref","forwarded"],"mappings":"4JACA,qDAOA,4DACA,qFAEA,sF,ouFAEO,GAAMA,CAAAA,oBAAoB,CAAGC,kBAAMC,aAAN,CAAoB,EAApB,CAA7B,C,kDAEQ,QAASC,CAAAA,8BAAT,EAQb,IAPAC,CAAAA,YAOA,2DAPe,EAOf,oEADI,EACJ,oBALEC,QAKF,CALEA,QAKF,wBALaC,iCAKb,yCAJEC,eAIF,CAJEA,eAIF,+BAJoB,KAIpB,sBAHEC,OAGF,MAHEA,OAGF,sBAFEC,UAEF,CAFEA,UAEF,0BAFe,KAEf,iBACA,MAAO,UAAAC,kBAAkB,CAAI,CAC3B,GAAMC,CAAAA,sBAAsB,CAC1BD,kBAAkB,CAACE,WAAnB,EAAkCF,kBAAkB,CAACG,IAArD,EAA6D,WAD/D,CAGA,QAASC,CAAAA,YAAT,OAA8C,IAAtBC,CAAAA,QAAsB,OAAtBA,QAAsB,CAATC,KAAS,8DACvB,sBAAWhB,oBAAX,CADuB,CACpCiB,QADoC,aACpCA,QADoC,CAE5C,GAAMC,CAAAA,WAAW,CAAG,kBAAOF,KAAP,CAApB,CAEA,qBAAU,UAAM,CAIdE,WAAW,CAACC,OAAZ,CAAsBH,KACvB,CALD,EAQA,GAAMI,CAAAA,UAAU,CAAGH,QAAQ,EAAIA,QAAQ,CAACT,OAAxC,CACA,GAAMa,CAAAA,YAAY,CAAG,uBAAY,iBAAMD,CAAAA,UAAN,CAAZ,CAA8B,CAACA,UAAD,CAA9B,CAArB,CAEA,GAAME,CAAAA,kBAAkB,CAAG,uBAAY,UAAM,CAC3C,GAAMC,CAAAA,eAAe,CACnB,MAAOnB,CAAAA,YAAP,GAAwB,UAAxB,CACIA,YAAY,CAACc,WAAW,CAACC,OAAb,CADhB,CAEIf,YAHN,CAIA,MAAOmB,CAAAA,eAAe,EAAI,EAC3B,CAN0B,CAMxB,EANwB,CAA3B,CAQA,GAAMC,CAAAA,iBAAiB,CAAG,uBAAY,UAAM,CAC1C,GAAMC,CAAAA,sBAAsB,CACzBR,QAAQ,EAAIA,QAAQ,CAACS,eAAtB,EAA0CJ,kBAD5C,CAGA,MAAO,kBACLG,CAAAA,sBAAsB,GAAKH,kBAA3B,CACIA,kBAAkB,EADtB,CAEI,0BAAMG,sBAAsB,EAA5B,CAAgCH,kBAAkB,EAAlD,CAHC,CAIR,CARyB,CAQvB,CAACA,kBAAD,CAAqBL,QAArB,CARuB,CAA1B,CAUA,GAAMU,CAAAA,qBAAqB,CAAG,uBAAY,UAAM,CAC9C,GAAMC,CAAAA,eAAe,CAAIX,QAAQ,EAAIA,QAAQ,CAACZ,QAAtB,EAAmCA,QAA3D,CACA,MAAO,UAAAwB,IAAI,QAAID,CAAAA,eAAe,CAAC,0BAAMN,kBAAkB,EAAxB,CAA4BO,IAAI,EAAI,EAApC,CAAD,CAAnB,CACZ,CAH6B,CAG3B,CAACP,kBAAD,CAAqBL,QAArB,CAH2B,CAA9B,CAKA,GAAMa,CAAAA,UAAU,CAAG,uBACjB,UAAe,IAAdD,CAAAA,IAAc,2DAAP,EAAO,CACbF,qBAAqB,GAAGE,IAAH,CACtB,CAHgB,CAIjB,CAACF,qBAAD,CAJiB,CAAnB,CAOA,qBAAU,UAAM,CACd,GAAMI,CAAAA,cAAc,CAAGV,YAAY,EAAnC,CACA,GAAMK,CAAAA,eAAe,CAAGF,iBAAiB,EAAzC,CAEA,GAAIH,YAAY,IAAMb,OAAtB,CAA+B,CAE7BwB,OAAO,CAACC,KAAR,CACE,kFADF,CAGD,CAED,GACE,MAAOF,CAAAA,cAAP,GAA0B,UAA1B,EACA,MAAOxB,CAAAA,eAAP,GAA2B,UAF7B,CAGE,CACAuB,UAAU,CACR,0BACEC,cAAc,CAACT,kBAAkB,EAAnB,CAAd,EAAwC,EAD1C,CAEEf,eAAe,CAACmB,eAAe,EAAhB,CAAf,EAAsC,EAFxC,CADQ,CAMX,CAVD,IAUO,IAAI,MAAOK,CAAAA,cAAP,GAA0B,UAA9B,CAA0C,CAC/C,GAAMG,CAAAA,SAAS,CAAGH,cAAc,CAACT,kBAAkB,EAAnB,CAAhC,CACA,GAAIY,SAAS,EAAI3B,eAAe,GAAK,IAArC,CAA2C,CACzCuB,UAAU,CAACI,SAAD,CACX,CACF,CALM,IAKA,IAAI,MAAO3B,CAAAA,eAAP,GAA2B,UAA/B,CAA2C,CAChDuB,UAAU,CAACvB,eAAe,CAACmB,eAAe,EAAhB,CAAhB,CACX,CAFM,IAEA,IAAInB,eAAe,GAAK,IAAxB,CAA8B,CACnCuB,UAAU,EACX,CACF,CA/BD,CA+BG,CAACR,kBAAD,CAAqBD,YAArB,CAAmCG,iBAAnC,CAAsDM,UAAtD,CA/BH,EAiCA,GAAMK,CAAAA,YAAY,CAAG,mBACnB,iBAAO,CACLL,UAAU,CAAVA,UADK,CAELJ,eAAe,CAAEF,iBAAiB,EAF7B,CAAP,CADmB,CAKnB,CAACM,UAAD,CAAaN,iBAAb,CALmB,CAArB,CAQA,GAAMY,CAAAA,YAAY,CAAG,mBACnB,iBAAO,CACLnB,QAAQ,CAAE,CACRZ,QAAQ,CAAEsB,qBAAqB,EADvB,CAERD,eAAe,CAAEF,iBAAiB,EAF1B,CAGRhB,OAAO,CAAEa,YAAY,IAAMb,OAHnB,CADL,CAAP,CADmB,CAQnB,CAACmB,qBAAD,CAAwBH,iBAAxB,CAA2CH,YAA3C,CARmB,CAArB,CAWA,GAAMgB,CAAAA,eAAe,CAAG,mBACtB,iBAAO5B,CAAAA,UAAU,kBAAQO,KAAR,EAAesB,GAAG,CAAEvB,QAApB,GAAiCC,KAAlD,CADsB,CAEtB,CAACA,KAAD,CAAQD,QAAR,CAFsB,CAAxB,CAKA,MAAO,mBACL,iBACE,iCAAC,oBAAD,CAAsB,QAAtB,EAA+B,KAAK,CAAEqB,YAAtC,EACE,gCAAC,kBAAD,aAAwBC,eAAxB,EAAyC,QAAQ,CAAEF,YAAnD,GADF,CADF,CADK,CAML,CAACC,YAAD,CAAeD,YAAf,CAA6BE,eAA7B,CANK,CAQR,CAED,GAAI5B,UAAJ,CAAgB,CACd,GAAM8B,CAAAA,SAAS,CAAGtC,kBAAMQ,UAAN,CAAiB,SAACO,KAAD,CAAQsB,GAAR,QACjC,iCAAC,YAAD,aAAkBtB,KAAlB,EAAyB,QAAQ,CAAEsB,GAAnC,GADiC,CAAjB,CAAlB,CAGAC,SAAS,CAAC3B,WAAV,wBAAwCD,sBAAxC,MACA,qCAAoB4B,SAApB,CAA+B7B,kBAA/B,EACA,MAAO6B,CAAAA,SACR,CAEDzB,YAAY,CAACF,WAAb,wBAA2CD,sBAA3C,MACA,qCAAoBG,YAApB,CAAkCJ,kBAAlC,EACA,MAAOI,CAAAA,YACR,CACF","sourcesContent":["/* eslint-disable react/jsx-props-no-spreading */\nimport React, {\n  useCallback,\n  useContext,\n  useEffect,\n  useMemo,\n  useRef,\n} from 'react';\nimport merge from 'deepmerge';\nimport hoistNonReactStatic from 'hoist-non-react-statics';\n\nimport dispatchTrackingEvent from './dispatchTrackingEvent';\n\nexport const ReactTrackingContext = React.createContext({});\n\nexport default function withTrackingComponentDecorator(\n  trackingData = {},\n  {\n    dispatch = dispatchTrackingEvent,\n    dispatchOnMount = false,\n    process,\n    forwardRef = false,\n  } = {}\n) {\n  return DecoratedComponent => {\n    const decoratedComponentName =\n      DecoratedComponent.displayName || DecoratedComponent.name || 'Component';\n\n    function WithTracking({ rtFwdRef, ...props }) {\n      const { tracking } = useContext(ReactTrackingContext);\n      const latestProps = useRef(props);\n\n      useEffect(() => {\n        // keep the latest props in a mutable ref object to avoid creating\n        // additional dependency that could cause unnecessary re-renders\n        // see https://reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often\n        latestProps.current = props;\n      });\n\n      // statically extract tracking.process for hook dependency\n      const trkProcess = tracking && tracking.process;\n      const getProcessFn = useCallback(() => trkProcess, [trkProcess]);\n\n      const getOwnTrackingData = useCallback(() => {\n        const ownTrackingData =\n          typeof trackingData === 'function'\n            ? trackingData(latestProps.current)\n            : trackingData;\n        return ownTrackingData || {};\n      }, []);\n\n      const getTrackingDataFn = useCallback(() => {\n        const contextGetTrackingData =\n          (tracking && tracking.getTrackingData) || getOwnTrackingData;\n\n        return () =>\n          contextGetTrackingData === getOwnTrackingData\n            ? getOwnTrackingData()\n            : merge(contextGetTrackingData(), getOwnTrackingData());\n      }, [getOwnTrackingData, tracking]);\n\n      const getTrackingDispatcher = useCallback(() => {\n        const contextDispatch = (tracking && tracking.dispatch) || dispatch;\n        return data => contextDispatch(merge(getOwnTrackingData(), data || {}));\n      }, [getOwnTrackingData, tracking]);\n\n      const trackEvent = useCallback(\n        (data = {}) => {\n          getTrackingDispatcher()(data);\n        },\n        [getTrackingDispatcher]\n      );\n\n      useEffect(() => {\n        const contextProcess = getProcessFn();\n        const getTrackingData = getTrackingDataFn();\n\n        if (getProcessFn() && process) {\n          // eslint-disable-next-line\n          console.error(\n            '[react-tracking] options.process should be defined once on a top-level component'\n          );\n        }\n\n        if (\n          typeof contextProcess === 'function' &&\n          typeof dispatchOnMount === 'function'\n        ) {\n          trackEvent(\n            merge(\n              contextProcess(getOwnTrackingData()) || {},\n              dispatchOnMount(getTrackingData()) || {}\n            )\n          );\n        } else if (typeof contextProcess === 'function') {\n          const processed = contextProcess(getOwnTrackingData());\n          if (processed || dispatchOnMount === true) {\n            trackEvent(processed);\n          }\n        } else if (typeof dispatchOnMount === 'function') {\n          trackEvent(dispatchOnMount(getTrackingData()));\n        } else if (dispatchOnMount === true) {\n          trackEvent();\n        }\n      }, [getOwnTrackingData, getProcessFn, getTrackingDataFn, trackEvent]);\n\n      const trackingProp = useMemo(\n        () => ({\n          trackEvent,\n          getTrackingData: getTrackingDataFn(),\n        }),\n        [trackEvent, getTrackingDataFn]\n      );\n\n      const contextValue = useMemo(\n        () => ({\n          tracking: {\n            dispatch: getTrackingDispatcher(),\n            getTrackingData: getTrackingDataFn(),\n            process: getProcessFn() || process,\n          },\n        }),\n        [getTrackingDispatcher, getTrackingDataFn, getProcessFn]\n      );\n\n      const propsToBePassed = useMemo(\n        () => (forwardRef ? { ...props, ref: rtFwdRef } : props),\n        [props, rtFwdRef]\n      );\n\n      return useMemo(\n        () => (\n          <ReactTrackingContext.Provider value={contextValue}>\n            <DecoratedComponent {...propsToBePassed} tracking={trackingProp} />\n          </ReactTrackingContext.Provider>\n        ),\n        [contextValue, trackingProp, propsToBePassed]\n      );\n    }\n\n    if (forwardRef) {\n      const forwarded = React.forwardRef((props, ref) => (\n        <WithTracking {...props} rtFwdRef={ref} />\n      ));\n      forwarded.displayName = `WithTracking(${decoratedComponentName})`;\n      hoistNonReactStatic(forwarded, DecoratedComponent);\n      return forwarded;\n    }\n\n    WithTracking.displayName = `WithTracking(${decoratedComponentName})`;\n    hoistNonReactStatic(WithTracking, DecoratedComponent);\n    return WithTracking;\n  };\n}\n"],"file":"withTrackingComponentDecorator.js"}